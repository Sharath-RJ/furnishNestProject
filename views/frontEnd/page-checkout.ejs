<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <title>Furnish Nest</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/frontEnd/images/banner/logo.png">
    <!-- Template CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha384-Gn538M5r5l5u5l5/Wc5L5xjO5tu5L5r5HR5e5z5f5z5o5T5U5y5x5B5O5m5C5d5" crossorigin="anonymous">
    <link rel="stylesheet" href="/frontEnd/stylesheets/main.css?v=3.4">

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Define the button style */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            /* Adjust padding as needed */
            background-color: #046963;
            /* Button background color */
            color: #fff;
            /* Text color */
            text-decoration: none;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            /* Add a hover effect */
        }

        /* Hover effect */
        .btn:hover {
            background-color: #046963;
            /* Change background color on hover */
        }
    </style>
</head>

<body>
    <main class="main">

        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <!-- <div class="col-lg-6 mb-sm-15">
                        <div class="toggle_info">
                            <span><i class="fi-rs-user mr-10"></i><span class="text-muted">Already have an
                                    account?</span> <a href="#loginform" data-bs-toggle="collapse" class="collapsed"
                                    aria-expanded="false">Click here to login</a></span>
                        </div>
                        <div class="panel-collapse collapse login_form" id="loginform">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have shopped with us before, please enter your details
                                    below. If you are a new customer, please proceed to the Billing &amp; Shipping
                                    section.</p>
                                    <div class="form-group">
                                        <input type="text" name="email" placeholder="Username Or Email">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="password" placeholder="Password">
                                    </div>
                                    <div class="login_footer form-group">
                                        <div class="chek-form">
                                            <div class="custome-checkbox">
                                                <input class="form-check-input" type="checkbox" name="checkbox"
                                                    id="remember" value="">
                                                <label class="form-check-label" for="remember"><span>Remember
                                                        me</span></label>
                                            </div>
                                        </div>
                                        <a href="#">Forgot password?</a>
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-md" name="login">Log in</button>
                                    </div>
                            </div>
                        </div>
                    </div> -->

                </div>
                <!-- <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div> -->
                <form action="" method="post" id="placeOrder">
                    <div class="row">
                        <div class="col-md-6">
                            <!--Address list start-->
                            <div class="col-md-6">
                                <h1>Address</h1>
                                <% for(add of address ) { %>
                                    <div class="d-flex mt-3 mb-3"
                                        style="border: 1px solid black; padding: 20px 25px; width:100%;">
                                        <input style="width: 20px;" type="radio" name="address_Radio"
                                            value="<%= add.address %>">
                                        <p style="width: 100%;">
                                            <%= add.address %>
                                        </p>
                                    </div>
                                    <% } %>
                                        <a href="/order/addAddressLoad"  id="showAddressForm" class="btn">Add Address</a>
                            </div>
                            <!--Address list end-->
                            <div class="col-lg-6 mt-4">

                                <div class=" " id="">
                                    <div class="panel-body">

                                        <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                        <div class="form-group">
                                            <input type="text" id="couponCode" oninput="convertUpperCase(this)" placeholder="Enter Coupon Code...">
                                        </div>
                                        <div class="d-flex justify-content-between">
                                        <div class="form-group">
                                            <button type="button" class="btn " id="apply-btn" onclick="applyCoupon()">Apply Coupon</button>
                                        </div>
                                        <div class="form-group">
                                            <button type="button" class="btn " id="showCoupon" onclick="showCoupons()" >Show Coupon</button>
                                        </div>
                                        </div>

                                        <!--MOdel for showing coupon-->
                                       



                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="order_review">
                                <div class="mb-20">
                                    <h4>Your Orders</h4>
                                </div>
                                <div class="table-responsive order_table text-center">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th colspan="2">Product</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% for(item of productInfo) { %>
                                                <tr>
                                                    <td class="image product-thumbnail"><img
                                                            src="/backEnd/images/cropped_image/<%=item.product.productImage[0]%>"
                                                            alt="#"></td>
                                                    <td>
                                                        <h5><a href="#"></a>
                                                            <%=item.product.productName %>
                                                        </h5>
                                                        <span class="product-qty">x <%=item.quantity %></span>
                                                    </td>
                                                    <td>₹ <%=item.product.sellingPrice %>
                                                    </td>
                                                </tr>
                                                <% } %>
                                                    <tr>
                                                        <th>SubTotal</th>
                                                        <td class="product-subtotal" colspan="2">
                                                           ₹<span id="subTotal"><%=totalAmount %></span>
                                                          
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th>Shipping</th>
                                                        <td colspan="2"><em>Free Shipping</em></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Discount</th>
                                                        <td colspan="2" id="discount"><em>0%</em></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Discounted Amount</th>
                                                        <td colspan="2" id="discountAmt"><em>0</em></td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total</th>
                                                        <td colspan="2" class="product-subtotal"><span
                                                                class="font-xl text-brand fw-900">
                                                               ₹ <span id="Total"><%=totalAmount %></span>
                                                            </span></td>
                                                    </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                                <div class="payment_method">
                                    <div class="mb-25">
                                        <h5>Payment</h5>
                                    </div>
                                    <div class="payment_option">
                                        <div class="custome-radio">
                                            <input class="form-check-input" value="online_payment" type="radio"
                                                name="payment_option" id="exampleRadios3">
                                            <label class="form-check-label" for="exampleRadios3"
                                                data-bs-toggle="collapse" data-target="#bankTranfer"
                                                aria-controls="bankTranfer">Online Payment</label>
                                            <div class="form-group collapse in" id="bankTranfer">
                                                <p class="text-muted mt-5">There are many variations of passages of
                                                    Lorem
                                                    Ipsum available, but the majority have suffered alteration. </p>
                                            </div>
                                        </div>
                                        <div class="custome-radio">
                                            <input class="form-check-input" value="Wallet_payment" type="radio" name="payment_option" id="exampleRadios5">
                                            <label class="form-check-label" for="exampleRadios5" data-bs-toggle="collapse" data-target="#walletPayment"
                                                aria-controls="walletPayment">Wallet Payment</label>
                                            <div class="form-group collapse in" id="walletPayment">
                                                <p class="text-muted mt-5">Please send your cheque to Store Name, Store
                                                    Street, Store Town, Store State / County, Store Postcode. </p>
                                            </div>
                                        </div>
                                        <div class="custome-radio">
                                            <input class="form-check-input" value="COD" type="radio"
                                                name="payment_option" id="exampleRadios4">
                                            <label class="form-check-label" for="exampleRadios4"
                                                data-bs-toggle="collapse" data-target="#checkPayment"
                                                aria-controls="checkPayment">Cash on delevery</label>
                                            <div class="form-group collapse in" id="checkPayment">
                                                <p class="text-muted mt-5">Please send your cheque to Store Name, Store
                                                    Street, Store Town, Store State / County, Store Postcode. </p>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <button type="submit">Place Order</button>
                </form>

            </div>
            </div>
            </div>
            </div>
        </section>
    </main>
    <!-- Preloader Start -->
    <!-- <div id="preloader-active">
        <div class="preloader d-flex align-items-center justify-content-center">
            <div class="preloader-inner position-relative">
                <div class="text-center">
                    <h5 class="mb-5">Now Loading</h5>
                    <div class="loader">
                        <div class="bar bar1"></div>
                        <div class="bar bar2"></div>
                        <div class="bar bar3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
    <!-- Vendor JS-->
    <script>
      
        function showCoupons(){
             $.ajax({
                url: '/coupon/showCoupon',
                method: 'GET',
                success: function (data) {
                 
                displayCouponsInSweetAlert(data.response);
            },
                error: function (err) {
                    console.log(err.responseJSON.error);
                    // Display an error message with SweetAlert
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                    });
                }
            }); 
        }
        let addAddressClicked = false
        const showAddressFormButton = document.getElementById("showAddressForm");
        const addressFormContainer = document.getElementById("address-form-container");
        showAddressFormButton.addEventListener("click", function () {
            addAddressClicked = true
            console.log(addAddressClicked)
        });
        function validatePlaceOrder() {
            const radioButtons = document.querySelectorAll('input[type="radio"][name="address_Radio"]')
            const paymentButtons = document.querySelectorAll('input[type="radio"][name="payment_option"]')
            let flag = 0
            for (let radioButton of radioButtons) {
                if (radioButton.checked) {
                    flag = 1
                    break
                }
            }
            let payment = false
            for (let paymentBtn of paymentButtons) {
                if (paymentBtn.checked) {
                    payment = true;
                    break; // Exit the loop if at least one is checked
                }
            }
            if (flag == 0) {
                alert("Address is requuired")
                return false
            }
            if (!addAddressClicked && flag == 0) {
                alert("Add Your Address")
                return false
            }
            if (!payment) {
                alert("Payment method is required")
                return false
            } else {
                return true
            }
        }

         function displayCouponsInSweetAlert(coupons) {
                // Build the HTML content for the SweetAlert modal
           var modalContent = '<div style="border: 1px solid #ccc; padding: 20px; text-align: left; max-width: 400px; margin: 20px auto; background-color: #fff; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">';

             coupons.forEach(function (coupon) {
                 modalContent += '<div style="border-bottom: 1px solid black; padding: 10px 0; margin-bottom: 10px;">';
                 modalContent += '<p style="color: #666; margin: 0;">' + "Coupon Code" + ': ' + coupon.code + '</p>';
                 modalContent += '<h5 style="color: #333; margin-top: 0;">' + coupon.description + '</h5>';
                 modalContent += '<h4 style="color: #009688; margin-bottom: 5px;">' + "Discount Upto ₹" + coupon.maxAmount + '</h4>';
                 modalContent += '<p style="color: #666; margin: 0;">' + "Valid till" + ': ' + coupon.expiry + '</p>';
                 modalContent += '</div>';
             });

             modalContent += '</div>';

               if(coupons.length>0){
                 // Display the SweetAlert modal
                   Swal.fire({
                       title: 'Available  Coupons',
                       html: modalContent,
                       confirmButtonColor: '#088178'
                   });
               }else{
                 // Display the SweetAlert modal
                   Swal.fire({
                       title: 'No Coupons Available',
                       confirmButtonColor: '#088178'
                   });
               }
               
            }
    
       
    </script>
    <script src="/frontEnd/javascripts/vendor/modernizr-3.6.0.min.js"></script>
    <script src="/frontEnd/javascripts/vendor/jquery-3.6.0.min.js"></script>
    <script src="/frontEnd/javascripts/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="/frontEnd/javascripts/vendor/bootstrap.bundle.min.js"></script>
    <script src="/frontEnd/javascripts/plugins/slick.js"></script>
    <script src="/frontEnd/javascripts/plugins/jquery.syotimer.min.js"></script>
    <script src="/frontEnd/javascripts/plugins/wow.js"></script>
    <script src="/frontEnd/javascripts/plugins/jquery-ui.js"></script>
    <script src="/frontEnd/javascripts/plugins/perfect-scrollbar.js"></script>
    <script src="/frontEnd/javascripts/plugins/magnific-popup.js"></script>
    <script src="/frontEnd/javascripts/plugins/select2.min.js"></script>
    <script src="/frontEnd/javascripts/plugins/waypoints.js"></script>
    <script src="/frontEnd/javascripts/plugins/counterup.js"></script>
    <script src="/frontEnd/javascripts/plugins/jquery.countdown.min.js"></script>
    <script src="/frontEnd/javascripts/plugins/images-loaded.js"></script>
    <script src="/frontEnd/javascripts/plugins/isotope.js"></script>
    <script src="/frontEnd/javascripts/plugins/scrollup.js"></script>
    <script src="/frontEnd/javascripts/plugins/jquery.vticker-min.js"></script>
    <!-- Template  JS -->
    <script src="/frontEnd/javascripts/main.js?v=3.4"></script>
    <script src="/frontEnd/javascripts/shop.js?v=3.4"></script>
    <script>
        $(document).ready(() => {
            console.log(addAddressClicked)
            $('#placeOrder').submit(function (e) {
                e.preventDefault()
                const formData = $(this).serialize()
                console.log(formData)
                let isvalid = validatePlaceOrder()
                if (isvalid) {
                    $.ajax({
                        method: "POST",
                        url: "/order/placingOrder",
                        data: formData,
                        success: function (response) {
                            if (response.response == 'codsuccess') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Order Placed Successfully',
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = "/continueShopping"
                                    }
                                })
                            }
                            else if(response.response=="no_balance"){
                                 Swal.fire({
                                    icon: 'error',
                                    title: 'Insufficient Balance in Wallet',
                                }).then((result) => {
                                     if (result.isConfirmed) {
                                         window.location.href = "/continueShopping"
                                     }
                                 })
                            }
                            else if(response.response=="walletUpdated"){
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Order Placed Successfully',
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = "/continueShopping"
                                    }
                                })
                            }
                            else if (response.response == 'out of stock') {
                                const dynamicContent = `<p>${response.product} <h3>is currently out of stock</h3></p>`
                                Swal.fire({
                                    icon: 'error',
                                    html: dynamicContent,
                                });
                            } else {
                                razorPayment(response); // Pass 'order' object to razorPayment function
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                        }
                    })
                } else {
                    // alert("Address is required")
                }
            })


            function razorPayment(order) {
                console.log("order " + order);
                var options = {
                    "key": "rzp_test_ZiJ0sdSeL9nVQz", // Replace with your Razorpay Key ID
                    "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                    "currency": "INR",
                    "name": "Furnish Nest",
                    "description": "Test Transaction",
                    "order_id": order.id,
                    "handler": function (response) {
                        console.log(response)
                        verifyPayment(JSON.stringify(response), JSON.stringify(order));
                    },
                    "prefill": {
                        "name": "Sharath",
                        "email": "gaurav.kumar@example.com",
                        "contact": "9000090000"
                    },
                    "notes": {
                        "address": "Razorpay Corporate Office"
                    }
                }


                var rzp1 = new Razorpay(options);
                rzp1.on('payment.failed', function (response) {
                    console.error(response.error.code);
                    console.error(response.error.description);
                    console.error(response.error.source);
                    console.error(response.error.step);
                    console.error(response.error.reason);
                    console.error(response.error.metadata.order_id);
                    console.error(response.error.metadata.payment_id);
                });
                rzp1.open();
            }


            function verifyPayment(payment, order) {
                $.ajax({
                    url: '/order/verify-payment',
                    data: {
                        payment: payment,
                        order: order
                    },
                    method: 'POST',
                    success: function (response) {
                        if (response.orderid) {
                    
                            Swal.fire({
                                icon: 'success',
                                title: 'Order Placed Successfully',
                            }).then((result)=>{
                                if(result.isConfirmed){
                                    window.location.href="/continueShopping"
                                }
                            })
                        }
                    },
                    error: function (error) {
                        if (error) {
                            window.location.href = '/errornotfound';
                        }
                    }
                });
            }
        })
        async function applyCoupon() {
            var coupon = $('#couponCode').val()
                 $.ajax({
                     method: "POST",
                     url: "/coupon/applyingCoupon",
                     data:{
                        couponCode:coupon
                     },
                     success:async function (response) {
                        if(response.response=="success")
                        {   alert("hrllo")
                              await Swal.fire({
                                icon: 'success',
                                title: 'Coupon Applied',
                            }); 
                            
                            var total = parseFloat($('#Total').text());
                          
                            $('#discount').text(response.discount+"%") 
                            $('#Total').text("₹"+response.discountedPrice).addClass('font-xl text-brand fw-900')
                            $('#discountAmt').text(discountAmt)
                            $('#subTotal').text(response.discountedPrice)
                            var totalNow=parseFloat($('#subTotal').text())
                            var discountAmt=total-totalNow
                            $('#discountAmt').text("₹"+discountAmt)
                             $('#apply-btn').text("Applied")
                            $('#apply-btn').prop("disabled",true)

                        }else if(response.response=="failed"){
                            console.log("failed")
                           
                              Swal.fire({
                                icon: 'error',
                                title: 'Cannot apply purchase more',
                            });   
                        }else if(response.response=="expired"){
                             Swal.fire({
                                icon: 'error',
                                title: 'Time expired cant apply',
                            });   
                        }else if(response.response=="exists"){
                               Swal.fire({
                                icon: 'warning',
                                title: 'Already Used this Coupon',
                            }); 
                        }else{
                           Swal.fire({
                                icon: 'error',
                                title: 'InValid Coupon',
                            });  
                        }

                     },
                     error: function (xhr, status, error) {
                         console.error(error);
                     }
                 })
    
        }

  function convertUpperCase(inputElement){
   inputElement.value = inputElement.value.toUpperCase();
  }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

</body>

</html>